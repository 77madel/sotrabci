/*
const { PrismaClient } = require('@prisma/client');
const bcrypt = require('bcryptjs');

// üîß Initialisation explicite du client Prisma
const prisma = new PrismaClient();

async function main() {
    console.log('üå± D√©but du seeding...');

    try {
        // V√©rifier si la caisse existe d√©j√†
        let caisse = await prisma.caisseGenerale.findFirst();

        if (!caisse) {
            // Cr√©er la caisse g√©n√©rale
            caisse = await prisma.caisseGenerale.create({
                data: {
                    soldeInitial: 100000,
                    soldeActuel: 100000,
                    devise: 'CFA'
                }
            });
            console.log('‚úÖ Caisse g√©n√©rale cr√©√©e');
        } else {
            console.log('‚ÑπÔ∏è Caisse g√©n√©rale existe d√©j√†');
        }

        // V√©rifier et cr√©er les utilisateurs
        const usersData = [
            {
                nom: 'Administrateur System',
                email: 'admin@gestion.com',
                role: 'ADMIN',
                motDePasse: 'admin123'
            },
            {
                nom: 'Pierre Dirigeant',
                email: 'dirigeant@gestion.com',
                role: 'DIRIGEANT',
                motDePasse: 'dirigeant123'
            },
            {
                nom: 'Marie Responsable',
                email: 'responsable@gestion.com',
                role: 'RESPONSABLE',
                motDePasse: 'responsable123'
            }
        ];

        for (const userData of usersData) {
            const existingUser = await prisma.utilisateur.findUnique({
                where: { email: userData.email }
            });

            if (!existingUser) {
                const hashedPassword = await bcrypt.hash(userData.motDePasse, 12);
                await prisma.utilisateur.create({
                    data: {
                        nom: userData.nom,
                        email: userData.email,
                        motDePasse: hashedPassword,
                        role: userData.role
                    }
                });
                console.log(`‚úÖ Utilisateur ${userData.email} cr√©√©`);
            } else {
                console.log(`‚ÑπÔ∏è Utilisateur ${userData.email} existe d√©j√†`);
            }
        }

        // Cr√©er des projets
        const responsable = await prisma.utilisateur.findUnique({
            where: { email: 'responsable@gestion.com' }
        });

        const dirigeant = await prisma.utilisateur.findUnique({
            where: { email: 'dirigeant@gestion.com' }
        });

        if (responsable && dirigeant) {
            const projetsData = [
                {
                    nom: 'Modernisation Infrastructure',
                    ministere: 'Int√©rieur',
                    responsableId: responsable.id,
                    dateDebut: new Date('2024-01-01')
                },
                {
                    nom: '√âquipements Scolaires',
                    ministere: '√âducation',
                    responsableId: responsable.id,
                    dateDebut: new Date('2024-02-01')
                },
                {
                    nom: 'Projet Aboville',
                    ministere: 'Personnel',
                    responsableId: dirigeant.id,
                    dateDebut: new Date('2024-03-01')
                }
            ];

            for (const projetData of projetsData) {
                const existingProjet = await prisma.projet.findFirst({
                    where: { nom: projetData.nom }
                });

                if (!existingProjet) {
                    const projet = await prisma.projet.create({
                        data: projetData
                    });

                    // Allouer un budget au projet
                    await prisma.budget.create({
                        data: {
                            montantAlloue: projetData.nom.includes('Infrastructure') ? 30000 :
                                projetData.nom.includes('Scolaires') ? 25000 : 20000,
                            projetId: projet.id,
                            caisseId: caisse.id
                        }
                    });

                    console.log(`‚úÖ Projet "${projetData.nom}" cr√©√© avec budget`);
                } else {
                    console.log(`‚ÑπÔ∏è Projet "${projetData.nom}" existe d√©j√†`);
                }
            }
        }

        // Cr√©er des salari√©s
        const salariesData = [
            {
                nom: 'Dupont',
                prenom: 'Jean',
                poste: 'Chef de projet',
                salaireBase: 3500,
                dateEmbauche: new Date('2023-01-15')
            },
            {
                nom: 'Martin',
                prenom: 'Sophie',
                poste: 'D√©veloppeur',
                salaireBase: 2800,
                dateEmbauche: new Date('2023-03-20')
            }
        ];

        for (const salarieData of salariesData) {
            const existingSalarie = await prisma.salarie.findFirst({
                where: {
                    nom: salarieData.nom,
                    prenom: salarieData.prenom
                }
            });

            if (!existingSalarie) {
                await prisma.salarie.create({
                    data: salarieData
                });
                console.log(`‚úÖ Salari√© ${salarieData.prenom} ${salarieData.nom} cr√©√©`);
            } else {
                console.log(`‚ÑπÔ∏è Salari√© ${salarieData.prenom} ${salarieData.nom} existe d√©j√†`);
            }
        }

        console.log('üéâ Seeding termin√© avec succ√®s !');

    } catch (error) {
        console.error('‚ùå Erreur lors du seeding:', error);
        throw error;
    }

// Ajouter des sites
    const site1 = await prisma.site.create({
        data: {
            nom: 'Site Aboville',
            adresse: '123 Rue Principale, Aboville',
            responsableSite: responsable.id
        }
    });

    const site2 = await prisma.site.create({
        data: {
            nom: 'Site Minist√®re Int√©rieur',
            adresse: '456 Avenue du Gouvernement, Paris',
            responsableSite: responsable.id
        }
    });

    console.log('‚úÖ Sites cr√©√©s');

// Mettre √† jour les projets avec les sites
    await prisma.projet.update({
        where: { id: projet1.id },
        data: { siteId: site1.id }
    });

    await prisma.projet.update({
        where: { id: projet2.id },
        data: { siteId: site2.id }
    });

    await prisma.projet.update({
        where: { id: projet3.id },
        data: { siteId: site1.id }
    });

    console.log('‚úÖ Projets associ√©s aux sites');
}

// Ex√©cution avec gestion propre des erreurs
main()
    .catch((e) => {
        console.error('üí• Erreur fatale:', e);
        process.exit(1);
    })
    .finally(async () => {
        await prisma.$disconnect();
        console.log('üîå D√©connexion de la base de donn√©es');
    });*/

const { PrismaClient } = require('@prisma/client');
const bcrypt = require('bcryptjs');

const prisma = new PrismaClient();

async function main() {
    console.log('üå± D√©but du seeding...');

    try {
        // V√©rifier si la caisse existe d√©j√†
        let caisse = await prisma.caisseGenerale.findFirst();

        if (!caisse) {
            // Cr√©er la caisse g√©n√©rale
            caisse = await prisma.caisseGenerale.create({
                data: {
                    soldeInitial: 100000,
                    soldeActuel: 100000,
                    devise: 'EUR'
                }
            });
            console.log('‚úÖ Caisse g√©n√©rale cr√©√©e');
        } else {
            console.log('‚ÑπÔ∏è Caisse g√©n√©rale existe d√©j√†');
        }

        // V√©rifier et cr√©er les utilisateurs
        const usersData = [
            {
                nom: 'Administrateur System',
                email: 'admin@gestion.com',
                role: 'ADMIN',
                motDePasse: 'admin123'
            },
            {
                nom: 'Pierre Dirigeant',
                email: 'dirigeant@gestion.com',
                role: 'DIRIGEANT',
                motDePasse: 'dirigeant123'
            },
            {
                nom: 'Marie Responsable',
                email: 'responsable@gestion.com',
                role: 'RESPONSABLE',
                motDePasse: 'responsable123'
            }
        ];

        const createdUsers = {};

        for (const userData of usersData) {
            const existingUser = await prisma.utilisateur.findUnique({
                where: { email: userData.email }
            });

            if (!existingUser) {
                const hashedPassword = await bcrypt.hash(userData.motDePasse, 12);
                const user = await prisma.utilisateur.create({
                    data: {
                        nom: userData.nom,
                        email: userData.email,
                        motDePasse: hashedPassword,
                        role: userData.role
                    }
                });
                createdUsers[userData.role.toLowerCase()] = user;
                console.log(`‚úÖ Utilisateur ${userData.email} cr√©√©`);
            } else {
                createdUsers[userData.role.toLowerCase()] = existingUser;
                console.log(`‚ÑπÔ∏è Utilisateur ${userData.email} existe d√©j√†`);
            }
        }

        // ‚úÖ CORRECTION : R√©cup√©rer les utilisateurs cr√©√©s
        const admin = createdUsers.admin;
        const dirigeant = createdUsers.dirigeant;
        const responsable = createdUsers.responsable;

        if (!admin || !dirigeant || !responsable) {
            throw new Error('Certains utilisateurs n\'ont pas pu √™tre cr√©√©s');
        }

        console.log('‚úÖ Tous les utilisateurs sont pr√™ts');

        // Cr√©er des sites
        const sitesData = [
            {
                nom: 'Site Aboville',
                adresse: '123 Rue Principale, Aboville',
                responsableSite: responsable.id
            },
            {
                nom: 'Site Minist√®re Int√©rieur',
                adresse: '456 Avenue du Gouvernement, Paris',
                responsableSite: responsable.id
            },
            {
                nom: 'Site √âducation Nationale',
                adresse: '789 Boulevard des √âcoles, Lyon',
                responsableSite: responsable.id
            }
        ];

        const createdSites = {};

        for (const siteData of sitesData) {
            const existingSite = await prisma.site.findFirst({
                where: { nom: siteData.nom }
            });

            if (!existingSite) {
                const site = await prisma.site.create({
                    data: siteData
                });
                createdSites[site.nom] = site;
                console.log(`‚úÖ Site "${siteData.nom}" cr√©√©`);
            } else {
                createdSites[siteData.nom] = existingSite;
                console.log(`‚ÑπÔ∏è Site "${siteData.nom}" existe d√©j√†`);
            }
        }

        console.log('‚úÖ Sites cr√©√©s');

        // Cr√©er des projets
        const projetsData = [
            {
                nom: 'Modernisation Infrastructure',
                ministere: 'Int√©rieur',
                responsableId: responsable.id,
                siteId: createdSites['Site Minist√®re Int√©rieur'].id,
                dateDebut: new Date('2024-01-01')
            },
            {
                nom: '√âquipements Scolaires',
                ministere: '√âducation',
                responsableId: responsable.id,
                siteId: createdSites['Site √âducation Nationale'].id,
                dateDebut: new Date('2024-02-01')
            },
            {
                nom: 'Projet Aboville',
                ministere: 'Personnel',
                responsableId: dirigeant.id,
                siteId: createdSites['Site Aboville'].id,
                dateDebut: new Date('2024-03-01')
            }
        ];

        const createdProjets = {};

        for (const projetData of projetsData) {
            const existingProjet = await prisma.projet.findFirst({
                where: { nom: projetData.nom }
            });

            if (!existingProjet) {
                const projet = await prisma.projet.create({
                    data: projetData
                });

                // Allouer un budget au projet
                let montantAlloue;
                if (projetData.nom.includes('Infrastructure')) {
                    montantAlloue = 30000;
                } else if (projetData.nom.includes('Scolaires')) {
                    montantAlloue = 25000;
                } else {
                    montantAlloue = 20000;
                }

                await prisma.budget.create({
                    data: {
                        montantAlloue: montantAlloue,
                        projetId: projet.id,
                        caisseId: caisse.id
                    }
                });

                createdProjets[projet.nom] = projet;
                console.log(`‚úÖ Projet "${projetData.nom}" cr√©√© avec budget de ${montantAlloue} ‚Ç¨`);
            } else {
                // ‚úÖ Mettre √† jour le siteId si le projet existe d√©j√†
                const updatedProjet = await prisma.projet.update({
                    where: { id: existingProjet.id },
                    data: { siteId: projetData.siteId }
                });
                createdProjets[projetData.nom] = updatedProjet;
                console.log(`‚úÖ Projet "${projetData.nom}" mis √† jour avec le site`);
            }
        }

        console.log('‚úÖ Projets cr√©√©s avec budgets');

        // Cr√©er des salari√©s
        const salariesData = [
            {
                nom: 'Dupont',
                prenom: 'Jean',
                poste: 'Chef de projet',
                salaireBase: 3500,
                dateEmbauche: new Date('2023-01-15')
            },
            {
                nom: 'Martin',
                prenom: 'Sophie',
                poste: 'D√©veloppeur',
                salaireBase: 2800,
                dateEmbauche: new Date('2023-03-20')
            },
            {
                nom: 'Bernard',
                prenom: 'Luc',
                poste: 'Analyste',
                salaireBase: 3200,
                dateEmbauche: new Date('2023-05-10')
            }
        ];

        const createdSalaries = {};

        for (const salarieData of salariesData) {
            const existingSalarie = await prisma.salarie.findFirst({
                where: {
                    nom: salarieData.nom,
                    prenom: salarieData.prenom
                }
            });

            if (!existingSalarie) {
                const salarie = await prisma.salarie.create({
                    data: salarieData
                });
                createdSalaries[`${salarieData.prenom} ${salarieData.nom}`] = salarie;
                console.log(`‚úÖ Salari√© ${salarieData.prenom} ${salarieData.nom} cr√©√©`);
            } else {
                createdSalaries[`${salarieData.prenom} ${salarieData.nom}`] = existingSalarie;
                console.log(`‚ÑπÔ∏è Salari√© ${salarieData.prenom} ${salarieData.nom} existe d√©j√†`);
            }
        }

        console.log('‚úÖ Salari√©s cr√©√©s');

        // Affecter des salari√©s aux projets
        const affectationsData = [
            {
                salarieId: createdSalaries['Jean Dupont'].id,
                projetId: createdProjets['Modernisation Infrastructure'].id
            },
            {
                salarieId: createdSalaries['Sophie Martin'].id,
                projetId: createdProjets['√âquipements Scolaires'].id
            },
            {
                salarieId: createdSalaries['Luc Bernard'].id,
                projetId: createdProjets['Projet Aboville'].id
            }
        ];

        for (const affectationData of affectationsData) {
            const existingAffectation = await prisma.affectationSalarie.findFirst({
                where: {
                    salarieId: affectationData.salarieId,
                    projetId: affectationData.projetId
                }
            });

            if (!existingAffectation) {
                await prisma.affectationSalarie.create({
                    data: affectationData
                });
                console.log(`‚úÖ Salari√© affect√© au projet`);
            } else {
                console.log(`‚ÑπÔ∏è Affectation existe d√©j√†`);
            }
        }

        console.log('‚úÖ Salari√©s affect√©s aux projets');

        // Cr√©er quelques besoins de test
        const besoinsData = [
            {
                description: 'Achat de mat√©riel informatique',
                montantEstime: 5000,
                projetId: createdProjets['Modernisation Infrastructure'].id
            },
            {
                description: 'Formation √©quipe',
                montantEstime: 3000,
                projetId: createdProjets['√âquipements Scolaires'].id
            },
            {
                description: 'Frais de d√©placement',
                montantEstime: 1500,
                projetId: createdProjets['Projet Aboville'].id
            }
        ];

        for (const besoinData of besoinsData) {
            const existingBesoin = await prisma.besoin.findFirst({
                where: {
                    description: besoinData.description,
                    projetId: besoinData.projetId
                }
            });

            if (!existingBesoin) {
                // R√©cup√©rer le siteId du projet automatiquement
                const projet = await prisma.projet.findUnique({
                    where: { id: besoinData.projetId },
                    select: { siteId: true }
                });

                await prisma.besoin.create({
                    data: {
                        ...besoinData,
                        siteId: projet.siteId // ‚úÖ Site r√©cup√©r√© automatiquement
                    }
                });
                console.log(`‚úÖ Besoin "${besoinData.description}" cr√©√©`);
            } else {
                console.log(`‚ÑπÔ∏è Besoin "${besoinData.description}" existe d√©j√†`);
            }
        }

        console.log('‚úÖ Besoins cr√©√©s');

        console.log('üéâ Seeding termin√© avec succ√®s !');

    } catch (error) {
        console.error('‚ùå Erreur lors du seeding:', error);
        throw error;
    }
}

// Ex√©cution avec gestion propre des erreurs
main()
    .catch((e) => {
        console.error('üí• Erreur fatale:', e);
        process.exit(1);
    })
    .finally(async () => {
        await prisma.$disconnect();
        console.log('üîå D√©connexion de la base de donn√©es');
    });